# 架构设计说明

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        前端层 (uni-app)                       │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────┐         ┌──────────────────┐              │
│  │  forum.vue   │────────▶│ post-detail.vue  │              │
│  │  (论坛列表)   │         │   (帖子详情)      │              │
│  └──────┬───────┘         └─────────┬────────┘              │
│         │                           │                        │
│         └───────────┬───────────────┘                        │
│                     │                                        │
│              ┌──────▼──────┐                                 │
│              │ PostCard.vue │                                │
│              │  (帖子卡片)   │                                │
│              └─────────────┘                                 │
│                                                               │
├─────────────────────────────────────────────────────────────┤
│                       API 封装层                              │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│              ┌─────────────────┐                             │
│              │  aliyunApi.js   │                             │
│              │  - queryPosts() │                             │
│              │  - getPost()    │                             │
│              │  - toggleFav()  │                             │
│              └────────┬────────┘                             │
│                       │                                      │
├───────────────────────┼──────────────────────────────────────┤
│                       │     工具函数层                        │
├───────────────────────┼──────────────────────────────────────┤
│                       │                                      │
│       ┌───────────────┴────────────┐                        │
│       │                            │                        │
│  ┌────▼──────┐            ┌────────▼────┐                  │
│  │distance.js│            │   time.js   │                  │
│  │距离计算   │            │  时间格式化  │                  │
│  └───────────┘            └─────────────┘                  │
│                                                              │
└──────────────────────────┬───────────────────────────────────┘
                           │
                    HTTP Request
                           │
┌──────────────────────────▼───────────────────────────────────┐
│              云函数层 (Aliyun Function Compute)               │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌────────────────┐              ┌────────────────┐         │
│  │  queryPosts    │              │    getPost     │         │
│  │  查询帖子列表   │              │  获取帖子详情   │         │
│  │                │              │                │         │
│  │ - 分页查询     │              │ - 详情查询     │         │
│  │ - 分类筛选     │              │ - 作者信息     │         │
│  │ - 距离计算     │              │ - 收藏状态     │         │
│  │ - 过期过滤     │              │ - 微信号       │         │
│  └───────┬────────┘              └────────┬───────┘         │
│          │                                │                 │
│          └────────────┬───────────────────┘                 │
│                       │                                     │
└───────────────────────┼─────────────────────────────────────┘
                        │
                  MongoDB Driver
                        │
┌───────────────────────▼─────────────────────────────────────┐
│                   数据库层 (MongoDB)                          │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────┐    ┌──────────┐    ┌─────────────┐           │
│  │  posts   │    │  users   │    │  favorites  │           │
│  │          │    │          │    │             │           │
│  │ - 帖子信息│    │ - 用户信息│    │ - 收藏关系 │           │
│  │ - 活动详情│    │ - 联系方式│    │ - user_id  │           │
│  │ - 地理位置│    │ - 隐私设置│    │ - post_id  │           │
│  └──────────┘    └──────────┘    └─────────────┘           │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

## 数据流向

### 1. 查询帖子列表流程
```
用户操作
   │
   ▼
forum.vue (加载/刷新/筛选)
   │
   ▼
api.queryPosts({ page, category, userLocation })
   │
   ▼
云函数 queryPosts
   │
   ├──▶ 查询 posts 集合 (过滤、分页、排序)
   │
   ├──▶ 查询 users 集合 (关联作者信息)
   │
   └──▶ 计算距离 (若有用户位置)
   │
   ▼
返回帖子列表
   │
   ▼
PostCard 渲染
   │
   ▼
展示给用户
```

### 2. 查看帖子详情流程
```
用户点击帖子卡片
   │
   ▼
navigateTo('/pages/post-detail?postId=xxx')
   │
   ▼
post-detail.vue onLoad
   │
   ▼
api.getPost({ postId, userId })
   │
   ▼
云函数 getPost
   │
   ├──▶ 查询 posts 集合 (根据 postId)
   │
   ├──▶ 查询 users 集合 (获取作者信息)
   │
   └──▶ 查询 favorites 集合 (判断收藏状态)
   │
   ▼
返回完整帖子详情
   │
   ▼
渲染详情页面
   │
   ▼
展示给用户
```

### 3. 收藏功能流程
```
用户点击收藏按钮
   │
   ▼
emit 'toggle-favorite' 事件
   │
   ▼
handleToggleFavorite()
   │
   ▼
api.toggleFavorite({ postId, userId, isFavorite })
   │
   ▼
云函数 toggleFavorite
   │
   ├──▶ 若收藏: 插入 favorites 记录 + 更新 fav_count
   │
   └──▶ 若取消: 删除 favorites 记录 + 更新 fav_count
   │
   ▼
返回操作结果
   │
   ▼
更新本地状态
   │
   ▼
显示操作提示
```

## 关键技术实现

### 1. 距离计算 (Haversine 公式)
```javascript
// 精确计算地球表面两点间的距离
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3; // 地球半径（米）
  // 将角度转换为弧度
  const φ1 = lat1 * Math.PI / 180;
  const φ2 = lat2 * Math.PI / 180;
  const Δφ = (lat2 - lat1) * Math.PI / 180;
  const Δλ = (lon2 - lon1) * Math.PI / 180;
  
  // Haversine 公式
  const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
           Math.cos(φ1) * Math.cos(φ2) *
           Math.sin(Δλ/2) * Math.sin(Δλ/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  
  return Math.round(R * c); // 返回米
}
```

### 2. 分页查询优化
```javascript
// 使用 skip 和 limit 实现分页
const skip = (page - 1) * pageSize;
const posts = await postsCollection
  .find(query)
  .sort({ created_at: -1 })  // 按时间倒序
  .skip(skip)
  .limit(pageSize)
  .toArray();

// 返回是否有更多数据
const hasMore = skip + posts.length < total;
```

### 3. 隐私保护
```javascript
// 只有当作者设置 show_wechat: true 时才返回微信号
if (author?.show_wechat === true && author?.wechat_id) {
  authorData.wechat_id = author.wechat_id;
}
```

### 4. 过期帖子过滤
```javascript
// 查询条件中排除已过期帖子
const query = {
  expires_at: { $gt: new Date() },  // 过期时间大于当前时间
  status: { $ne: 'expired' }        // 状态不为已过期
};
```

## 性能优化建议

### 1. 数据库索引
```javascript
// MongoDB 建议创建以下索引
db.posts.createIndex({ created_at: -1 });
db.posts.createIndex({ expires_at: 1 });
db.posts.createIndex({ category: 1 });
db.posts.createIndex({ author_id: 1 });
db.favorites.createIndex({ user_id: 1, post_id: 1 });
```

### 2. 云函数优化
- 使用连接池复用 MongoDB 连接
- 缓存客户端实例（cachedClient）
- 并行查询优化（Promise.all）

### 3. 前端优化
- 分页加载减少单次数据量
- 图片懒加载
- 防抖处理上拉加载
- 本地状态缓存

## 错误处理机制

### 统一错误码
- `0`: 成功
- `4001`: 参数错误（客户端问题）
- `4004`: 资源未找到
- `5001`: 服务器错误（服务端问题）

### 错误处理流程
```
错误发生
   │
   ▼
云函数捕获异常
   │
   ▼
返回统一格式错误
   │
   ▼
前端 API 层接收
   │
   ▼
显示友好提示
   │
   └──▶ Toast 提示 / 错误状态展示
```

## 安全考虑

1. **数据验证**: 所有云函数入参都进行严格校验
2. **隐私保护**: 微信号等敏感信息需要授权才返回
3. **SQL注入防护**: 使用 MongoDB 原生查询方法
4. **XSS防护**: 前端渲染时注意转义
5. **权限控制**: 收藏等操作需要用户登录

## 扩展性设计

### 1. 新增分类
只需在前端 categories 数组和云函数查询条件中添加

### 2. 新增云函数
按照现有模式创建新目录和 index.js，在 aliyunApi.js 添加接口

### 3. 新增页面
复用 PostCard 组件和工具函数，保持代码一致性

### 4. 数据库扩展
MongoDB 的文档型数据库易于添加新字段
